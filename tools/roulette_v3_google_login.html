<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatToEat ë£°ë › v3.0 - Google ë¡œê·¸ì¸</title>
    
    <!-- Google Sign-In ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* ë¡œê·¸ì¸ ì˜ì—­ */
        .auth-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        #user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #667eea;
        }

        #user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .sign-out-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .sign-out-btn:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        /* MBTI ëª¨ë‹¬ */
        .mbti-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .mbti-modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mbti-modal h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .mbti-modal p {
            color: #666;
            margin-bottom: 20px;
        }

        #mbti-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            font-family: 'Pretendard', sans-serif;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .save-btn {
            background: #667eea;
            color: white;
        }

        .save-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .skip-btn {
            background: #e0e0e0;
            color: #666;
        }

        .skip-btn:hover {
            background: #d0d0d0;
        }

        /* ê¸°ì¡´ ë£°ë › ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .header {
            text-align: center;
            padding: 2rem 1rem;
            animation: fadeInDown 0.8s ease-out;
        }

        .title {
            color: white;
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: 400;
        }

        /* ê°œì¸í™” í‘œì‹œ */
        .personalized-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
            backdrop-filter: blur(10px);
        }

        /* X ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .remove-menu-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            z-index: 10;
        }

        .menu-category-card:hover .remove-menu-btn {
            display: block;
        }

        /* ë‚˜ë¨¸ì§€ ë£°ë › ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼... */
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸/ì‚¬ìš©ì ì •ë³´ ì˜ì—­ -->
    <div class="auth-container">
        <div id="google-signin-button"></div>
        <div id="user-info" style="display: none;">
            <img id="user-avatar" src="" alt="í”„ë¡œí•„">
            <span id="user-name"></span>
            <button class="sign-out-btn" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <div class="header">
        <h1 class="title">ì˜¤ëŠ˜ ë­ë¨¹ì§€?</h1>
        <p class="subtitle">í”„ë¦¬ë¯¸ì—„ ë£°ë ›ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”</p>
        <div id="personalized-indicator" style="display: none;">
            <span class="personalized-badge">
                <span id="user-mbti"></span> ë§ì¶¤ ë£°ë ›
            </span>
        </div>
    </div>

    <!-- ì—¬ê¸°ì— ê¸°ì¡´ ë£°ë › HTML ì¶”ê°€ -->
    
    <script>
        // Google ë¡œê·¸ì¸ ì´ˆê¸°í™”
        let CLIENT_ID = '662688031132-gq477hpobp0ssnjhtf4lpqba3rnp1bbp.apps.googleusercontent.com';
        
        function initializeGoogleSignIn() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: true,
                cancel_on_tap_outside: false
            });

            google.accounts.id.renderButton(
                document.getElementById("google-signin-button"),
                { 
                    theme: "outline", 
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    logo_alignment: "left"
                }
            );

            // ê¸°ì¡´ ë¡œê·¸ì¸ í™•ì¸
            const savedUser = localStorage.getItem('userInfo');
            if (savedUser) {
                displayUserInfo(JSON.parse(savedUser));
                checkUserMBTI(JSON.parse(savedUser).id);
            } else {
                google.accounts.id.prompt();
            }
        }

        // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            
            const userInfo = {
                id: responsePayload.sub,
                name: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture
            };
            
            localStorage.setItem('userInfo', JSON.stringify(userInfo));
            displayUserInfo(userInfo);
            checkUserMBTI(userInfo.id);
            
            // ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ê¸°ë¡
            recordUserAction('login', { userId: userInfo.id });
        }

        // JWT ë””ì½”ë”©
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        function displayUserInfo(userInfo) {
            document.getElementById('google-signin-button').style.display = 'none';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('user-avatar').src = userInfo.picture;
            document.getElementById('user-name').textContent = userInfo.name;
        }

        // MBTI í™•ì¸
        function checkUserMBTI(userId) {
            const savedMBTI = localStorage.getItem('userMBTI');
            
            if (!savedMBTI) {
                setTimeout(() => showMBTIModal(), 1000);
            } else {
                showPersonalizedIndicator(savedMBTI);
                personalizeRoulette(savedMBTI);
            }
        }

        // MBTI ëª¨ë‹¬ í‘œì‹œ
        function showMBTIModal() {
            const modalHTML = `
                <div class="mbti-modal-overlay" id="mbti-modal-overlay">
                    <div class="mbti-modal">
                        <h2>MBTIë¥¼ ì•Œë ¤ì£¼ì„¸ìš”! ğŸ§ </h2>
                        <p>ë” ì •í™•í•œ ë©”ë‰´ ì¶”ì²œì„ ìœ„í•´ í•„ìš”í•´ìš” ğŸ˜Š</p>
                        <select id="mbti-select">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="INTJ">INTJ - ìš©ì˜ì£¼ë„í•œ ì „ëµê°€</option>
                            <option value="INTP">INTP - ë…¼ë¦¬ì ì¸ ì‚¬ìƒ‰ê°€</option>
                            <option value="ENTJ">ENTJ - ëŒ€ë‹´í•œ í†µì†”ì</option>
                            <option value="ENTP">ENTP - ë…¼ìŸì„ ì¦ê¸°ëŠ” ë³€ë¡ ê°€</option>
                            <option value="INFJ">INFJ - ì„ ì˜ì˜ ì˜¹í˜¸ì</option>
                            <option value="INFP">INFP - ì—´ì •ì ì¸ ì¤‘ì¬ì</option>
                            <option value="ENFJ">ENFJ - ì •ì˜ë¡œìš´ ì‚¬íšŒìš´ë™ê°€</option>
                            <option value="ENFP">ENFP - ì¬ê¸°ë°œë„í•œ í™œë™ê°€</option>
                            <option value="ISTJ">ISTJ - ì²­ë ´ê²°ë°±í•œ ë…¼ë¦¬ì£¼ì˜ì</option>
                            <option value="ISFJ">ISFJ - ìš©ê°í•œ ìˆ˜í˜¸ì</option>
                            <option value="ESTJ">ESTJ - ì—„ê²©í•œ ê´€ë¦¬ì</option>
                            <option value="ESFJ">ESFJ - ì‚¬êµì ì¸ ì™¸êµê´€</option>
                            <option value="ISTP">ISTP - ë§ŒëŠ¥ ì¬ì£¼ê¾¼</option>
                            <option value="ISFP">ISFP - í˜¸ê¸°ì‹¬ ë§ì€ ì˜ˆìˆ ê°€</option>
                            <option value="ESTP">ESTP - ëª¨í—˜ì„ ì¦ê¸°ëŠ” ì‚¬ì—…ê°€</option>
                            <option value="ESFP">ESFP - ììœ ë¡œìš´ ì—°ì˜ˆì¸</option>
                        </select>
                        <div class="modal-buttons">
                            <button class="save-btn" onclick="saveMBTI()">ì €ì¥</button>
                            <button class="skip-btn" onclick="skipMBTI()">ë‚˜ì¤‘ì—</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // MBTI ì €ì¥
        function saveMBTI() {
            const mbti = document.getElementById('mbti-select').value;
            if (mbti) {
                localStorage.setItem('userMBTI', mbti);
                showPersonalizedIndicator(mbti);
                personalizeRoulette(mbti);
                closeModal();
                
                // MBTI ì„ íƒ ì´ë²¤íŠ¸ ê¸°ë¡
                recordUserAction('mbti_selected', { mbti: mbti });
            }
        }

        // MBTI ê±´ë„ˆë›°ê¸°
        function skipMBTI() {
            closeModal();
            recordUserAction('mbti_skipped', {});
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            const modal = document.getElementById('mbti-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // ê°œì¸í™” í‘œì‹œ
        function showPersonalizedIndicator(mbti) {
            document.getElementById('personalized-indicator').style.display = 'block';
            document.getElementById('user-mbti').textContent = mbti;
        }

        // ë£°ë › ê°œì¸í™”
        function personalizeRoulette(mbti) {
            const settings = {
                mbti: mbti,
                hiddenMenus: JSON.parse(localStorage.getItem('hiddenMenus') || '[]'),
                favoriteMenus: [],
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('userRouletteSettings', JSON.stringify(settings));
            
            // ìˆ¨ê¸´ ë©”ë‰´ë“¤ ì ìš©
            settings.hiddenMenus.forEach(menuId => {
                const card = document.querySelector(`[data-menu-id="${menuId}"]`);
                if (card) {
                    card.style.display = 'none';
                }
            });
        }

        // ë©”ë‰´ ì œê±° (X ë²„íŠ¼)
        function removeMenuItem(menuId) {
            const hiddenMenus = JSON.parse(localStorage.getItem('hiddenMenus') || '[]');
            if (!hiddenMenus.includes(menuId)) {
                hiddenMenus.push(menuId);
                localStorage.setItem('hiddenMenus', JSON.stringify(hiddenMenus));
            }
            
            // UIì—ì„œ ì œê±°
            const card = document.querySelector(`[data-menu-id="${menuId}"]`);
            if (card) {
                card.style.display = 'none';
            }
            
            // ë°ì´í„° ìˆ˜ì§‘
            const mbti = localStorage.getItem('userMBTI');
            recordUserAction('menu_removed', {
                menuId: menuId,
                mbti: mbti || 'unknown'
            });
        }

        // ì‚¬ìš©ì í–‰ë™ ê¸°ë¡ (ìµëª…í™”)
        function recordUserAction(action, data) {
            const timestamp = new Date().toISOString();
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            
            const actionData = {
                action: action,
                timestamp: timestamp,
                data: data,
                sessionId: generateSessionId() // ìµëª… ì„¸ì…˜ ID
            };
            
            // ë¡œì»¬ ì €ì¥ (ë‚˜ì¤‘ì— ì„œë²„ë¡œ ì „ì†¡)
            const actions = JSON.parse(localStorage.getItem('userActions') || '[]');
            actions.push(actionData);
            localStorage.setItem('userActions', JSON.stringify(actions));
            
            console.log('Action recorded:', actionData);
        }

        // ì„¸ì…˜ ID ìƒì„±
        function generateSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }

        // ë¡œê·¸ì•„ì›ƒ
        function signOut() {
            google.accounts.id.disableAutoSelect();
            
            // ê°œì¸ ì„¤ì •ì€ ìœ ì§€, ë¡œê·¸ì¸ ì •ë³´ë§Œ ì‚­ì œ
            localStorage.removeItem('userInfo');
            
            location.reload();
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            // Google Sign-In ì´ˆê¸°í™”ëŠ” Client ID ì„¤ì • í›„ ì‹¤í–‰
            if (CLIENT_ID !== 'YOUR_CLIENT_ID.apps.googleusercontent.com') {
                initializeGoogleSignIn();
            } else {
                console.warn('Google Client IDë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!');
                // ê°œë°œ ëª¨ë“œì—ì„œëŠ” ê°€ì§œ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('google-signin-button').innerHTML = 
                    '<button onclick="devLogin()">ê°œë°œì ë¡œê·¸ì¸</button>';
            }
        });

        // ê°œë°œì ëª¨ë“œ ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸ìš©)
        function devLogin() {
            const devUser = {
                id: 'dev_user_123',
                name: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
                email: 'test@example.com',
                picture: 'https://via.placeholder.com/150'
            };
            localStorage.setItem('userInfo', JSON.stringify(devUser));
            displayUserInfo(devUser);
            checkUserMBTI(devUser.id);
        }
    </script>
</body>
</html>